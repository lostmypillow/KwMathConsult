# KwConsult API
- [KwConsult API](#kwconsult-api)
  - [Project Structure](#project-structure)
  - [Development](#development)
    - [0. Prerequisites](#0-prerequisites)
    - [1. Virtual Environment](#1-virtual-environment)
    - [2. Running Dev Server](#2-running-dev-server)
        - ["the hassle"?](#the-hassle)
  - [Production](#production)
    - [0. Fill out server details in .env.production file](#0-fill-out-server-details-in-envproduction-file)
    - [1. Install Docker](#1-install-docker)
    - [2. Start Containers](#2-start-containers)
  - [Docker](#docker)
    - [Common Commands](#common-commands)
    - [Why Docker?](#why-docker)
    - [What is Portainer?](#what-is-portainer)
  - [Author(s)](#authors)

## Project Structure
```
── [root folder]/
    ├── .vscode
    │   ├── launch.json          # Autogenerated by VSCode
    │   ├── tasks.json           # Autogenerated by VSCode
    │   └── extensions.json      # Extensions that I use
    ├── sql                      # All SQL commands
    ├── documentation
    │   ├── index.html           # Open this file for docs!
    │   └── [other html files]   # IGNORE!
    ├── src/
    │   ├── __init__.py          # Some program needs this idk
    │   ├── cardholder.py        # Cardholder class
    │   ├── database.py          # executeSQL function
    │   ├── device.py            # Device class
    │   └── main.py              # FastAPI entrypoint
    ├── .env.developement        # Development env
    ├── .env.production          # Should be self explanatory
    ├── .gitignore               # Things that Git ignores
    ├── docker-compose.debug.yml # Development Compose file 
    ├── docker-compose.yml       # Production Compose file
    ├── Dockerfile               # Self explanatory
    ├── README.md                #...?
    ├── requirements.txt         # Python requirements.txt
    └── test.txt                 # Numbers I use for testing

```
- FastAPI's documentation is at the "/docs" endpoint when you run `fastapi dev main.py` or launch Docker Debug.
- Alternatively, launch pdoc via `pdoc src` in the terminal.
- Run `pdoc src -o ./documentation` after creating a virtual environment to generate the pdoc HTML files after a change in any source files.
- Run `pip freeze > requirements.txt when you add a new python dependency

## Development

### 0. Prerequisites
1. See [this](https://github.com/mkleehammer/pyodbc/wiki/Install) for things to do before installing pyodbc with pip
   
2. If on Linux, see [this](https://learn.microsoft.com/en-us/sql/connect/odbc/linux-mac/installing-the-microsoft-odbc-driver-for-sql-server?view=sql-server-ver16&tabs=ubuntu18-install%2Cdebian17-install%2Cdebian8-install%2Credhat7-13-install%2Crhel7-offline#17) for installing the MS ODBC 17 driver for SQL Server
3. Fill out server details in the .env file

### 1. Virtual Environment
1. Create a virtual environment using the requirements.txt in this repo
   - VSCode: 
     1. Ctrl/Command + Shift + P 
     2. Select Python:Create Environment
     3. Check requirements.txt when prompted

   - PyCharm: It should automatically prompt you to install prerequisites from requirements.txt

   - If all else fails, on Linux:
      ```bash
      python3 -m venv .venv
      source .venv/bin/activate

      # and for when you want to exit the venv:
      deactivate
      ```
### 2. Running Dev Server
1. [Install Docker](https://docs.docker.com/engine/install/). [Why Docker?](#why-docker)
2. Run Dev Server by running `fastapi dev main.py` **OR** click Run & Debug(Ctrl+Shift+D) and run a debug Docker to save you the hassle.

##### "the hassle"?
FastAPI might not shutdown correctly (release ports) even after you Ctrl+C when running `fastapi dev` directly with the terminal (this problem wouldn't exist if you use Docker Debug, see next point). Just kill the running Python process (using Task Manager in Windows or `kill [insert python process PID here]` on Linux)
  


## Production

### 0. Fill out server details in .env.production file
   
### 1. Install Docker
   
```bash
curl -fsSL https://get.docker.com -o get-docker.sh

sudo sh get-docker.sh
```

### 2. Start Containers

```bash
docker compose up -d

# Or specific containers
docker compose up -d kwconsultapi
# or
docker compose up -d portainer
```

- The `-d` flag indicates detached, that way it won't start spitting logs in the terminal and won't be ended with a Ctrl+C. 

- See next section for more about using Docker

## Docker

### Common Commands
```bash
#List running containers
docker ps

# List images
docker images

# Shut down container
  # Run this in the same folder as the docker-compose.yml
  # Does not remove images!
docker compose down

# remove images
docker rmi name_of_image
```
For more see [Docker Official Reference](https://docs.docker.com/reference/cli/docker/)


### Why Docker?
**Docker ensures the ability to reproduce the same application across different operating systems.** It's especially needed here with all the prerequisites to pyodbc and all that MSSQL drivers.

### What is Portainer?
Portainer is an optional utility that visualizes everything Docker using a web interface running on `https://(machineIP):9443`

It is optional because docker CLI commands can do eveything Portainer can do, and it is why it's commented out in the Docker Compose file and not default.

In the last production server (that I know), however, there *is* Portainer set up using an old Docker Compose file. Username is `kaowei`, password `kaoweikaowei`.


## Author(s)
Johnny (Lost) - jmlin0101@gmail.com